\documentclass[11pt,twoside,a4paper]{book}
\usepackage[shorthands=off,english]{babel} % package for multilingual support

\RequirePackage{iftex}
\ifPDFTeX
    \usepackage[utf8]{inputenc} 
    \usepackage[T1]{fontenc}
    % \usepackage{lmodern}
\else
    \RequirePackage{fontspec} % UFT8 fonts for LuaLaTeX
    % \setmainfont{Latin Modern Roman}
\fi
\usepackage{csquotes}

\usepackage[ backend=biber
           , style=alphabetic % numeric
           , sortlocale=en_US
           , bibencoding=UTF8
           , sorting=anyt % explicit label, name, year, title
           , maxnames=4
           , maxalphanames=4
           , maxbibnames=100
           , urldate=long
           ]{biblatex}
\DeclareSourcemap{
    \maps[datatype=bibtex, overwrite]{
        \map{
            \step[fieldset=editor, null]
            \step[fieldset=language, null]
        }
    }
}

\usepackage{xcolor}
\definecolor{dark-red}{rgb}{0.6,0.15,0.15}
\definecolor{dark-green}{rgb}{0.15,0.4,0.15}
\definecolor{medium-blue}{rgb}{0,0,0.5}
\usepackage[ pdfauthor={Vladimir Still}
           , pdftitle={Analysis of Parallel C++ Programs},
           , pdfsubject={PHD Thesis},
           , plainpages=false
           , pdfpagelabels
           , unicode
           , draft=false
           , colorlinks=true
           , linkcolor={dark-red}
           , citecolor={dark-green}
           , urlcolor={medium-blue}
           , unicode=true
           ]{hyperref}

\usepackage{amssymb,amsmath,amsthm}
\usepackage{verbatim}
\usepackage{paralist}
\usepackage{multicol}
% use upquote for straight quotes in verbatim environments
\usepackage{upquote}
\usepackage{minted}

\newminted[cppcode]{cpp}{autogobble,breaklines}
\newminted[cppcodeln]{cpp}{autogobble,breaklines,linenos}
\newmintinline[cpp]{cpp}{}

\newmintinline[java]{java}{}

\newmintinline[llvmcode]{llvm}{autogobble,breaklines}
\newmintedfile[llvminput]{llvm}{breaklines}
\newmintinline[li]{llvm}{}

\usepackage{xspace}
\usepackage{pgf}
\usepackage{tikz}
\usetikzlibrary{arrows,positioning,shapes,snakes,automata,backgrounds,petri,fit,matrix,decorations.pathreplacing}
\tikzset{
    *|/.style={
        to path={
            (perpendicular cs: horizontal line through={(\tikztostart)},
                                 vertical line through={(\tikztotarget)})
            % is the same as (\tikztostart -| \tikztotarget)
            % but just to be safe: http://tex.stackexchange.com/a/29781/16595
            -- (\tikztotarget) \tikztonodes
        }
    },
	|*/.style={to path={
		(\tikztostart) -- (perpendicular cs: vertical line through={(\tikztostart)},
											 horizontal line through={(\tikztotarget)})
  	}}
}
\usepackage{pgfplots}
\pgfplotsset{
    every axis/.append style={
        axis on top,
        scatter/classes={ %
            tt={mark=square,thick,green!70!black}, %
            tT={mark=x,thick,green!70!black}, %
            fT={mark=x,thick,blue}, %
            MT={mark=x,thick,black}, %
            TT={mark=x,thick,black}, %
            MM={mark=x,thick,black}, %
            tf={mark=triangle,thick,red}, %
            ft={mark=triangle,thick,red}, %
            ff={mark=o,thick,blue}
        }, scatter src=explicit symbolic, axis equal
    }
}
\usepackage{pdfpages}

\usepackage{float}
\makeatletter
% custom float style, derived from ruled
% - caption is at the bottom
% - spaces before and after figure are larger
% - rules are thinner
% - bottom rule is missing
\newcommand\floatc@botruled[2]{{\@fs@cfont #1} #2\par}
\newcommand\fs@botruled{\def\@fs@cfont{\bfseries}\let\@fs@capt\floatc@botruled
    \def\@fs@pre{\hrule\kern0.5\abovecaptionskip}%
    \def\@fs@post{}%
    \def\@fs@mid{\kern0.5\abovecaptionskip\hrule\kern0.5\abovecaptionskip}%
\let\@fs@iftopcapt\iffalse}
\makeatother
\floatstyle{botruled}
\restylefloat{figure}
\usepackage[labelfont=bf]{caption}
\usepackage{subcaption}

\usepackage{multirow}
\usepackage{microtype}

\usepackage{tabularx}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}
\newcolumntype{L}{>{}X}
\usepackage{booktabs}
\usepackage{arydshln}

\newcommand{\divine}{\mbox{DIVINE}\xspace}
\newcommand{\divm}{Di\hspace*{-0.66pt}VM\xspace}
\newcommand{\dios}{DiOS\xspace}
\newcommand{\lart}{\mbox{LART}\xspace}

\newcommand{\llvm}{LLVM\xspace}
\newcommand{\ltl}{LTL\xspace}
\newcommand{\complexity}[1]{\textsc{#1}\xspace}
\newcommand{\PSPACE}{\complexity{PSPACE}}

\newcommand{\tso}{TSO\xspace}
\newcommand{\pso}{PSO\xspace}
\newcommand{\xtso}{\mbox{x86-\kern-.15em TSO}\xspace}

\newcommand{\FI}{Faculty of Informatics}
\newcommand{\MU}{Masaryk University}

\newcommand{\Jirik}{prof. RNDr. Jiří Barnat, Ph.D.}
\newcommand{\Mornfall}{RNDr. Petr Ročkai, Ph.D.}

\newcommand{\thesistitle}{Analysis of Parallel C++ Programs} % enter thesis title
\newcommand{\thesissubtitle}{PHD Thesis}
\newcommand{\thesisauthor}{Vladimír Štill}
\newcommand{\thesisYearCity}{Brno, 2020}
\newcommand{\thesisadvisor}{\Jirik}

\newcommand{\note}{\textit{Note:}\xspace}
\newcommand{\fcite}[1]{\emergencystretch 3em\fullcite{#1}~\cite{#1}\medskip}

\renewcommand{\indent}{\mbox{}\ \ \ \ }
\colorlet{frombuf}{green!60!black}
\colorlet{flushed}{yellow!60!red!85!black}

\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}{Lemma}[chapter]

\newtheoremstyle{mydefstyle}%
  {\topsep}% space above (default)
  {\topsep}% space below (default)
  {}% body font
  {}% indent amount
  {\bf}% theorem head font
  {}% Punctuation after theorem head
  {\newline}% space after theorem head
  {\thmname{#1}\thmnumber{ #2}\thmnote{: #3}}% theorem head spec (empty = normal)
\theoremstyle{mydefstyle}
\newtheorem{definition}{Definition}[chapter]

\addbibresource{thesis.bib}
\addbibresource{my.bib}

\usepackage[a4paper,
            bindingoffset=2cm, inner=1.5cm, outer=1.5cm, top=4cm, bottom=4cm,
            headheight=15.2pt, % for the sake of fancyhdr
            includemp, % count outer margin outside of the marginpar
            marginparsep=0.8cm, marginparwidth=3.5cm]{geometry}
\usepackage{fancyhdr}
\fancyhf{}
\fancyhead[RO]{\footnotesize\rightmark}
\fancyhead[LE]{\footnotesize\leftmark}
% \fancyhead[RO, LE]{\footnotesize\thepage}
\fancyfoot[C]{\footnotesize\thepage}
\renewcommand{\headrulewidth}{0pt} % remove lines after header
\renewcommand{\footrulewidth}{0pt}
% also restyle the chapter start page
\fancypagestyle{plain}{
  \fancyhf{}
  % \fancyhead[RO, LE]{\footnotesize\thepage}
  \fancyfoot[C]{\footnotesize\thepage}
  \renewcommand{\headrulewidth}{0pt}
}
% set marks for headers -- chapter mark contains only the chapter name, section
% mark has the dot after the section number removed (to match the actual
% section heading)
\pagestyle{fancy} % initialize before setting marks
\makeatletter
\def\chaptermark#1{%
  \markboth{\MakeUppercase{%
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
        %\@chapapp\ \thechapter \ %
      \fi
    \fi
    #1}}{}}
\def\sectionmark#1{%
  \markright {\MakeUppercase{%
    \ifnum \c@secnumdepth >\z@
      \thesection \ %
    \fi
    #1}}}
\makeatother

\usepackage{setspace}

\usepackage{enumitem}
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}%
  \setlength{\parskip}{0pt}%
  \setlength{\topsep}{0pt}%
  \setlength{\partopsep}{0pt}}

\newcommand{\TODO}[1]{{\bf\color{red}#1}}
\renewcommand{\comment}[1]{\xspace}

% autoref names
\addto\extrasenglish{
    \renewcommand{\chapterautorefname}{Chapter}
    \renewcommand{\sectionautorefname}{Section}
    \renewcommand{\subsectionautorefname}{Section}
    \def\definitionautorefname{Definition}
}

\newcommand{\rot}[1]{\rotatebox{90}{#1\hspace*{0.5em}}}

\setlength{\overfullrule}{5pt} % TODO: remove

% try to avoid overfull lines, taken from \sloppy, but without allowing greater
% tolerance for paragraphs without any problems
% \emergencystretch 3em

\newenvironment{stretched}{\emergencystretch 3em}{}

\setcounter{tocdepth}{1}

\usepackage{pdfpages}

%% MARGIN NOTES %%
\usepackage{marginfix}
\usepackage{ragged2e}
\usepackage{ifoddpage}
\newcommand{\raggedout}{\checkoddpage\ifoddpage\RaggedRight\else\RaggedLeft\fi}
\newcounter{mnote}[chapter]
\newcommand{\mnotemark}{\stepcounter{mnote}\hyperlink{mnote:\thechapter:\themnote}{${}^{\arabic{mnote}}$}\xspace}
\newcommand{\mnotetext}[1]{\marginpar{\raggedout\hypertarget{mnote:\thechapter:\themnote}{${}^{\arabic{mnote}}\,$}\footnotesize{}#1}}
\newcommand{\mnote}[1]{\mnotemark{}\mnotetext{#1}}


\usepackage{listofitems}
\newcommand{\internalmcite}[3][]{\cite[#1]{#2}%
\readlist*\cilist{#2}%
\foreachitem\ci\in\cilist[]{%
\ifcsname mcite: \thepage : \ci\endcsname \else\expandafter\def\csname mcite: \thepage : \ci\endcsname{}\marginpar{\raggedout\footnotesize\cite{\ci} \citeauthor*{\ci}, \citetitle{\ci}.#3}\fi%
}}
\newcommand{\mcite}[2][]{\internalmcite[#1]{#2}{}}
\newcommand{\mucite}[2][]{\internalmcite[#1]{#2}{ \citeurl{#2}}}

% set space between margin notes -- unofficial, but works (unline \marginskip)
\setlength\marginparpush\bigskipamount
%%

\newcommand{\srcnote}[1]{\emph{#1}}

\clubpenalty=2000
\widowpenalty=2000

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
% initial pages from Mornfall + modifications
\frontmatter

\begin{titlepage}
\newgeometry{margin=4cm}
\begin{center}
    {\Large \sc \FI, \MU}
    \vskip4em
    \includegraphics[width = 4cm, height = 4cm] {logo_fi.pdf}
    \vskip4em
    {\begin{spacing}{1}
        \Huge \bf \thesistitle
    \end{spacing}}
    \vskip2em
    {\Large \sc \thesissubtitle}
    \vskip4em
    {\LARGE \bf \thesisauthor}
    \vfill
\end{center}
\textbf{Supervisor:}\\
\thesisadvisor \hfill \thesisYearCity
\end{titlepage}

\pagestyle{fancy}
\cleardoublepage

\section*{Abstract}
\input{abstract}

%\vfill
\clearpage
\section*{Keywords}
\TODO{relaxed memory, memory models, parallelism, software verification, program transformation,
LLVM, C++, DIVINE, implementation}
\cleardoublepage

\section*{Acknowledgments}
\input{acknowledgements}
\cleardoublepage

\tableofcontents % prints table of contents
\mainmatter

\chapter{Introduction}\label{chap:introduction}
\input{intro}

\chapter{Preliminaries}\label{chap:preliminaries}
\input{preliminaries}

\chapter{State of the Art}\label{chap:stateoftheart}
\input{stateoftheart}

\chapter{Programming Language Support}\label{chap:lang}
\input{realprogs}

\chapter{The \xtso Relaxed Memory Model}\label{chap:mm}
\input{memorymodels}

\chapter{Termination of Parallel Programs}\label{chap:lnterm}
\input{termination}

\chapter{Conclusion}\label{chap:conclusion}

\appendix

\chapter{Published Papers}\label{chap:published}
\input{papers}

\chapter{Bibliography}
% \addcontentsline{toc}{chapter}{Bibliography}

{
    \emergencystretch 3em % there is little other fixing possible for bibio
    \printbibliography[heading=none]
}

\end{document}
